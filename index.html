<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta property="og:title" content="Spotify Clone App">
<meta property="og:description" content="Listen to music like Spotify. Your music library and more.">
<meta property="og:image" content="s512.png"> 
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
<meta property="og:type" content="website">
<meta property="og:url" content="https://your-github-username.github.io/your-repo-name/">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Spotify Clone App">
<meta name="twitter:description" content="Listen to music like Spotify. Your music-library and more.">
<meta name="twitter:image" content="s512.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify </title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1db954">
<link rel="apple-touch-icon" href="s192.png">
<style>
/* ---------------------------------------------------- */
/* --- Global Styles & Variables --- */
/* ---------------------------------------------------- */
:root {
    --spotify-black: #121212;
    --spotify-dark-grey: #181818;
    --spotify-light-grey: #b3b3b3;
    --spotify-green: #1db954;
    --text-faded: #a7a7a7;
    --bg-darker: #000000;
}

body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: var(--spotify-black);
    color: white;
    min-height: 100vh;
}

/* --- Main View Container & Pages --- */
.main-content {
    /* Keep this padding to ensure main page content scrolls above fixed mini-player/footer */
    padding-bottom: 120px; 
}

.app-page {
    display: none; /* Hide all pages initially */
    min-height: 100vh; /* Allow content to push height beyond the viewport for scrolling */
}

.app-page.active {
    display: block;
    /* Ensure only the active page scrolls */
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
}

/* --- Track/Item List (Re-used for Library & Popular Tracks) --- */
.track-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.track-item {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.1s ease;
    opacity: 0;
    transform: translateY(10px);
}

.track-item.show {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}

.track-item:hover {
    background-color: var(--spotify-dark-grey);
}

.track-item.playing .track-info h3 {
    color: var(--spotify-green); 
}

.track-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    margin-right: 12px;
    border-radius: 4px; 
}

.track-info {
    flex-grow: 1;
    min-width: 0; 
}

.track-info h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.track-info p {
    margin: 2px 0 0 0;
    font-size: 13px;
    color: var(--text-faded);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.track-duration {
    font-size: 13px;
    color: var(--text-faded);
    margin-right: 15px;
}
.track-item .track-duration {
    display: none; 
}

/* --- EXPANDED PLAYER STYLES (Single-Scroll View) --- */
.expanded-player {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, #004d40 0%, var(--bg-darker) 100%);
    z-index: 100; 
    display: flex; 
    flex-direction: column; 
    padding: 0; 
    box-sizing: border-box;
    transition: transform 0.3s ease-in-out; 
    transform: translateY(100%); 
}

.expanded-player.active { 
    transform: translateY(0); 
}

.player-content-wrapper {
    flex-grow: 1; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; 
    padding-bottom: 80px; 
}

/* Clickable Artist Name in Player Details */
.player-details p {
    /* Style to suggest clickability */
    text-decoration: underline; 
    text-underline-offset: 2px;
}

/* --- UPDATED ARTIST CARD STYLES (Player Card) --- */
.artist-card-expanded {
    background: var(--spotify-dark-grey); 
    border-radius: 12px;
    padding: 0; 
    margin: 20px 16px; 
    overflow: hidden;
}
.artist-banner-area {
    height: 300px; 
    position: relative;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    color: white;
    padding-left: 16px;
    padding-right: 16px;
    box-shadow: inset 0 -100px 50px -50px rgba(0, 0, 0, 0.7);
}
.artist-banner-area h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-faded);
    margin-top: 20px;
    margin-bottom: 10px;
}
.artist-details-overlay {
    padding: 16px;
    padding-top: 10px; 
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.artist-details-overlay h2 {
    font-size: 32px; 
    font-weight: 700;
    margin: 0;
}
.artist-details-overlay p {
    font-size: 16px;
    color: var(--text-faded);
    margin: 0;
}
.follow-btn-large {
    align-self: flex-start;
    padding: 10px 30px;
    border: 1px solid white;
    border-radius: 25px;
    color: white;
    background: none;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 14px;
    margin-top: 15px;
}

/* ---------------------------------------------------- */
/* --- NEW: ARTIST PAGE STYLES (Spotify Mimic) --- */
/* ---------------------------------------------------- */
.artist-page {
    /* Overrides the global .app-page style for full bleed header */
    padding: 0; 
}

.artist-header {
    height: 400px; /* Large header area */
    position: relative;
    padding-top: 40px;
    padding-left: 16px;
    padding-right: 16px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Push content to the bottom */
    background-size: cover;
    background-position: center 20%;
    background-repeat: no-repeat;
    /* Gradient overlay to ensure text is readable and track list blends */
    box-shadow: inset 0 -120px 50px -20px var(--spotify-black);
}

.artist-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    /* Soften the background image and ensure text visibility */
    background: linear-gradient(to top, var(--spotify-black) 0%, rgba(0, 0, 0, 0.1) 40%, rgba(0, 0, 0, 0.5) 100%);
    z-index: 1;
}

.artist-header > * {
    position: relative;
    z-index: 2; /* Keep content above the pseudo-element overlay */
}

.artist-name-large {
    font-size: 48px;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    line-height: 1.1;
}

.monthly-listeners {
    font-size: 14px;
    color: white;
    font-weight: 600;
    margin-top: 5px;
    margin-bottom: 20px;
}

.artist-controls {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.follow-btn-artist-page {
    padding: 10px 20px;
    border: 1px solid white;
    border-radius: 25px;
    color: white;
    background: none;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 12px;
}

.play-btn-artist-page {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--spotify-green);
    color: var(--spotify-black);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    cursor: pointer;
}

.artist-song-section {
    padding-bottom: 50px;
    background-color: var(--spotify-black); /* Ensure the content below the header is fully black */
    padding-top: 10px;
}
.artist-song-section h2 {
    font-size: 18px;
    font-weight: 700;
    padding-left: 16px;
    margin-bottom: 10px;
}

/* Style for Popular Track Items */
.popular-track-item {
    display: flex;
    align-items: center;
    padding: 6px 16px;
    cursor: pointer;
}

.popular-track-item .track-rank {
    width: 25px;
    font-size: 16px;
    text-align: right;
    color: var(--text-faded);
    margin-right: 12px;
}

.popular-track-item .track-img {
    width: 45px;
    height: 45px;
    border-radius: 2px;
}

.popular-track-item .track-info h3 {
    /* Title text should be smaller on this page */
    font-size: 15px;
    font-weight: 400;
}
.popular-track-item .track-info p {
    font-size: 12px;
    color: var(--text-faded);
}
.popular-track-item.playing .track-rank {
    color: var(--spotify-green);
    font-weight: 700;
    /* Hide rank when playing, show speaker icon */
    display: none; 
}
.popular-track-item.playing::before {
    content: '\f028'; /* Font Awesome Speaker Icon */
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    color: var(--spotify-green);
    font-size: 16px;
    width: 25px;
    text-align: center;
    margin-right: 12px;
}
.popular-track-item.playing .track-info h3 {
    color: var(--spotify-green);
}
.popular-track-item:not(.playing) .track-rank {
    display: block;
}


/* --- MINI PLAYER & FOOTER NAV remain unchanged --- */

</style>
</head>
<body>

<div class="main-content">
    
    <div class="app-page" id="homePage">
        <div class="library-header">
             <span style="font-size: 30px;">ðŸ‘‹ Hello!</span>
        </div>
        <h2 style="padding: 0 16px;">It's New Music Friday!</h2>
        <div style="height: 300px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
            <p>Home Feed Content Placeholder</p>
        </div>
    </div>

    <div class="app-page" id="searchPage">
        <div class="search-header">
            <span class="title">Search</span>
            <i class="fas fa-camera"></i>
        </div>
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="What do you want to listen to?">
        </div>
        
        <ul class="track-list" id="searchResultsContainer">
            </ul>
        
        <div class="browsing-section" id="browsingSection">
            <h3 class="start-browsing">Start browsing</h3>
            <div class="browsing-grid">
                <div class="grid-item">Music</div>
                <div class="grid-item">Podcasts</div>
                <div class="grid-item">Live Events</div>
                <div class="grid-item">Home of I-Pop</div>
            </div>
            
            <h3 class="start-browsing">Discover something new</h3>
            <div style="height: 200px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                <p>Discovery Carousel Placeholder</p>
            </div>
        </div>
    </div>

    <div class="app-page active" id="libraryPage">
        <div class="library-header">
            <span class="title">Your Library</span>
            <div><i class="fas fa-search" id="librarySearchIcon" style="margin-right: 20px; cursor: pointer;"></i><i class="fas fa-plus" style="cursor: pointer;"></i></div>
        </div>
        
        <div class="library-filter-tabs">
            <div class="filter-tab active">Playlists</div>
            <div class="filter-tab">Albums</div>
            <div class="filter-tab">Artists</div>
        </div>

        <div class="library-controls">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-arrow-up"></i>
                <i class="fas fa-arrow-down" style="margin-right: 15px;"></i>
                <span>Recents</span>
            </div>
            <i class="fas fa-th-large" style="margin-right: 0;"></i> </div>

        <ul class="track-list" id="musicContainer">
            <div style="height: 800px; background: #121212; display: flex; justify-content: center; align-items: center; color: var(--text-faded);">
                <p>More scrollable content added for testing.</p>
            </div>
            </ul>
    </div>
    
    
    <div class="app-page artist-page" id="artistPage">
        
        <div class="artist-header" id="artistHeader">
            <i class="fas fa-arrow-left" id="artistPageBackBtn" style="color:white; font-size: 24px; position:absolute; top: 20px; left: 16px; z-index: 10;"></i>
            
            <h1 class="artist-name-large" id="artistPageName"></h1>
            <p class="monthly-listeners" id="artistPageListeners">1.2 Cr monthly listeners</p>
            
            <div class="artist-controls">
                <button class="follow-btn-artist-page">Follow</button>
                <div class="play-btn-artist-page" id="artistPagePlayBtn">
                    <i class="fas fa-play"></i>
                </div>
            </div>
        </div>
        
        <div class="artist-song-section">
            <h2>Popular</h2>
            <ul class="track-list" id="artistPopularTracks">
                </ul>
            
            <div style="padding: 16px; color: var(--text-faded); text-align: center; margin-top: 20px;">
                <p>Other Albums and Singles content would go here.</p>
            </div>
        </div>
        
    </div>
    </div>

<div class="expanded-player" id="expandedPlayer">
    
    <div class="player-content-wrapper">
        
        <div class="player-header">
            <i class="fas fa-chevron-down" id="minimizeBtn"></i>
            <div class="playlist-indicator">
                PLAYING FROM PLAYLIST<br>
                <span id="playerTitleSmall" style="color:white; font-size:14px;"></span>
            </div>
            <i class="fas fa-ellipsis-v"></i>
        </div>

        <div class="player-art-container">
            <img class="player-art" id="playerArt" src="" alt="Album Art">
        </div>

        <div class="player-details">
            <div>
                <h2 id="playerTrackTitle"></h2>
                <p id="playerArtistName" style="cursor: pointer;"></p>
            </div>
            <i class="fas fa-check-circle" id="likeBtn" style="color:var(--spotify-green); font-size:24px; cursor:pointer;"></i>
        </div>

        <div class="progress-container">
            <input type="range" id="playerProgress" min="0" max="100" value="0">
            <div class="time-stamps">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <div class="controls-row">
            <button id="shuffleBtn"><i class="fas fa-random"></i></button>
            <button id="prevBtn"><i class="fas fa-step-backward"></i></button>
            <button class="main-play" id="mainPlayBtn"><i class="fas fa-play"></i></button>
            <button id="nextBtn"><i class="fas fa-step-forward"></i></button>
            <button id="repeatBtn"><i class="fas fa-redo-alt"></i></button>
        </div>
        
        <div class="controls-row" style="font-size: 18px; margin-top: -10px; margin-bottom: 20px;">
            <button><i class="fas fa-volume-up"></i></button>
            <button><i class="fas fa-mobile-alt"></i></button>
            <button><i class="fas fa-share-alt"></i></button>
            <button id="downloadBtn"><i class="fas fa-download"></i></button> 
        </div>

        <div class="scrollable-content">
            
            <div class="artist-card-expanded">
                <div class="artist-banner-area" id="artistBannerArea">
                    <h3 style="margin: 0;">About the artist</h3>
                </div>
                
                <div class="artist-details-overlay">
                    <h2 id="expandedArtistName"></h2>
                    <p id="expandedMonthlyListeners"></p>
                    <button class="follow-btn-large">Follow</button>
                </div>
            </div>
            
            <div class="lyrics-preview" style="text-align:center; padding: 15px; background:rgba(255,255,255,0.05); border-radius: 12px; margin: 10px 16px;">
                <p style="margin: 0; font-size: 14px; color: var(--spotify-light-grey);">Lyrics will appear here</p>
                <p style="font-size: 18px; font-weight: 700;">Scroll Down to Read!</p>
            </div>
            
            <div style="height: 300px;"></div> 
            
        </div>
    </div>
</div>

<div class="mini-player" id="miniPlayer">
    <img id="miniArt" src="" alt="Album Art" class="track-img" style="width: 40px; height: 40px; border-radius: 2px;">
    <div class="mini-track-info">
        <h4 id="miniTitle"></h4>
        <p id="miniArtist"></p>
    </div>
    <div class="mini-controls">
        <button class="mini-check"><i class="fas fa-check"></i></button>
        <button id="miniPlayBtn"><i class="fas fa-play"></i></button>
    </div>
</div>

<div class="footer-nav">
    <div class="nav-item" data-page="homePage">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </div>
    <div class="nav-item" data-page="searchPage">
        <i class="fas fa-search"></i>
        <span>Search</span>
    </div>
    <div class="nav-item active" data-page="libraryPage">
        <i class="fas fa-book"></i>
        <span>Your Library</span>
    </div>
    <div class="nav-item">
        <i class="fab fa-spotify"></i>
        <span>Premium</span>
    </div>
</div>
  <script type="module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA",
    authDomain: "gymnm-ce84b.firebaseapp.com",
    projectId: "gymnm-ce84b",
    storageBucket: "gymnm-ce84b.appspot.com",
    messagingSenderId: "474926929394",
    appId: "1:474926929394:web:6abdb807caba2751a5c76b",
    measurementId: "G-6R9S8LYZNF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- GLOBAL STATE ---
let allTracks = [];
let currentTrackIndex = -1;
let currentAudio = new Audio();
let isPlaying = false;

// --- DOM ELEMENTS ---
const musicContainer = document.getElementById('musicContainer');
const expandedPlayer = document.getElementById('expandedPlayer');
const miniPlayer = document.getElementById('miniPlayer');
const mainPlayBtn = document.getElementById('mainPlayBtn');
const miniPlayBtn = document.getElementById('miniPlayBtn');
const footerNavItems = document.querySelectorAll('.nav-item');
const downloadBtn = document.getElementById('downloadBtn'); 
const librarySearchIcon = document.getElementById('librarySearchIcon'); 
const playerArtistName = document.getElementById('playerArtistName'); // NEW: Get artist name in player

// ARTIST PAGE ELEMENTS
const artistHeader = document.getElementById('artistHeader');
const artistPageName = document.getElementById('artistPageName');
const artistPopularTracks = document.getElementById('artistPopularTracks');
const artistPagePlayBtn = document.getElementById('artistPagePlayBtn');


// --- HELPER FUNCTIONS ---
function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

function getTrackDurationFromURL(url, trackElement) {
    const tempAudio = new Audio(url);
    
    tempAudio.preload = 'metadata';

    tempAudio.onloadedmetadata = () => {
        const duration = Math.round(tempAudio.duration);
        const index = parseInt(trackElement.dataset.index);
        const trackInAllTracks = allTracks.find(t => t.index === index);
        if(trackInAllTracks) {
            trackInAllTracks.duration = duration;
        }
    };
}


// --- NAVIGATION LOGIC ---

function navigateToPage(pageId) {
    document.querySelectorAll('.app-page').forEach(page => {
        page.classList.remove('active');
        // Ensure that when switching pages, we reset scroll position for the new page
        page.scrollTop = 0; 
    });
    document.getElementById(pageId).classList.add('active');

    footerNavItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) {
            item.classList.add('active');
        }
    });

    if (pageId !== 'searchPage') {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResultsContainer').innerHTML = '';
        document.getElementById('browsingSection').classList.remove('hidden');
    }
}

footerNavItems.forEach(item => {
    item.addEventListener('click', () => {
        const pageId = item.getAttribute('data-page');
        if (pageId) {
            navigateToPage(pageId);
        }
    });
});

if (librarySearchIcon) {
    librarySearchIcon.addEventListener('click', () => {
        navigateToPage('searchPage');
    });
}
// New: Back button for Artist Page
document.getElementById('artistPageBackBtn').addEventListener('click', () => {
    // Navigate back to the Library or Search page (or home if unsure)
    navigateToPage('libraryPage'); 
});


// --- PLAYER CONTROLS ---

function togglePlayPause() {
    if (currentTrackIndex === -1) return;

    if (isPlaying) {
        currentAudio.pause();
        isPlaying = false;
        mainPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
        miniPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
    } else {
        currentAudio.play().catch(e => console.error("Play failed:", e));
        isPlaying = true;
        mainPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
        miniPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
    }
    updatePlaylistView();
}

function loadTrack(index, autoPlay = true) {
    const track = allTracks.find(t => t.index === index);
    if (!track) return;

    if(currentAudio && isPlaying) {
        currentAudio.pause();
        isPlaying = false;
    }

    currentTrackIndex = index;
    const imageSource = track.image_base64 || "https://via.placeholder.com/200/181818/1db954?text=No+Art";
    const artistImageSource = track.artist_image_base64 || ''; 

    currentAudio.src = track.url;
    currentAudio.load();

    // Update Player Details
    document.getElementById('playerArt').src = imageSource;
    document.getElementById('playerTrackTitle').textContent = track.title;
    document.getElementById('playerArtistName').textContent = track.artist;
    document.getElementById('playerTitleSmall').textContent = track.title;
    
    document.getElementById('miniArt').src = imageSource;
    document.getElementById('miniTitle').textContent = track.title;
    document.getElementById('miniArtist').textContent = track.artist;
    miniPlayer.classList.add('active');
    
    // Updated Artist Card Display Logic (inside Expanded Player)
    document.getElementById('expandedArtistName').innerHTML = `${track.artist} <i class="fas fa-check-circle" style="color:#3d94ff; font-size:16px;"></i>`;
    document.getElementById('expandedMonthlyListeners').textContent = '32.5L monthly listeners'; 

    const artistBannerArea = document.getElementById('artistBannerArea');
    if (artistImageSource) {
         artistBannerArea.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.8)), url('${artistImageSource}')`;
         artistBannerArea.style.backgroundColor = 'transparent';
    } else {
         artistBannerArea.style.backgroundImage = 'none';
         artistBannerArea.style.backgroundColor = '#303030';
    }
    

    document.getElementById('playerProgress').value = 0;
    document.getElementById('currentTime').textContent = '0:00';
    document.getElementById('totalTime').textContent = formatTime(track.duration || 0); 
    
    if (autoPlay) {
        isPlaying = false; 
        togglePlayPause();
        document.getElementById('expandedPlayer').classList.add('active'); 
    } else {
        mainPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
        miniPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
    }

    updatePlaylistView();
}

function nextTrack() {
    let nextIndex = (currentTrackIndex + 1) % allTracks.length;
    loadTrack(nextIndex);
}

function prevTrack() {
    let prevIndex = (currentTrackIndex - 1 + allTracks.length) % allTracks.length;
    loadTrack(prevIndex);
}

function updatePlaylistView() {
    const updateItems = (container) => {
        container.querySelectorAll('.track-item, .popular-track-item').forEach(item => {
            item.classList.remove('playing');
            if (parseInt(item.dataset.index) === currentTrackIndex && isPlaying) {
                item.classList.add('playing');
            }
        });
    }
    updateItems(document.getElementById('musicContainer'));
    updateItems(document.getElementById('searchResultsContainer'));
    updateItems(document.getElementById('artistPopularTracks'));
}

// Attach player listeners once
mainPlayBtn.addEventListener('click', togglePlayPause);
miniPlayBtn.addEventListener('click', togglePlayPause);
document.getElementById('nextBtn').addEventListener('click', nextTrack);
document.getElementById('prevBtn').addEventListener('click', prevTrack);
document.getElementById('minimizeBtn').addEventListener('click', () => {
    document.getElementById('expandedPlayer').classList.remove('active');
});
miniPlayer.addEventListener('click', (e) => {
    if(e.target.closest('#miniPlayBtn')) return; 
    if (currentTrackIndex !== -1) {
        document.getElementById('expandedPlayer').classList.add('active');
    }
});
// Attach event listener to Artist Name in the Expanded Player
playerArtistName.addEventListener('click', (e) => {
    const artistName = e.target.textContent.trim();
    if (artistName) {
        document.getElementById('expandedPlayer').classList.remove('active');
        loadArtistPage(artistName);
    }
});


// --- CORE DATA LOADING & RENDERING FUNCTIONS ---

function createTrackListItem(data, type = 'list') {
    const item = document.createElement('li');
    // Use the actual track index for the loadTrack function
    item.dataset.index = data.index; 
    
    const imageSource = data.image_base64 || "https://via.placeholder.com/50/121212/FFFFFF?text=A";
    
    if (type === 'list') {
        item.className = 'track-item';
        item.innerHTML = `
            <img class="track-img" src="${imageSource}" alt="Album Art">
            <div class="track-info">
                <h3>${data.title}</h3>
                <p>Single â€¢ ${data.artist || 'Unknown Artist'}</p>
            </div>
        `;
    } else if (type === 'popular') {
        // New structure for popular songs on the artist page
        item.className = 'popular-track-item';
        // Placeholder for rank, will be set externally
        const rank = parseInt(data.rank) + 1;
        item.innerHTML = `
            <span class="track-rank">${rank}</span>
            <img class="track-img" src="${imageSource}" alt="Album Art">
            <div class="track-info">
                <h3>${data.title}</h3>
                <p>${data.artist || 'Unknown Artist'}</p>
            </div>
            <i class="fas fa-ellipsis-v" style="color:var(--text-faded); margin-left: auto;"></i>
        `;
    }

    item.addEventListener('click', () => {
        loadTrack(data.index, true); 
    });
    
    // Apply animation visibility if needed (for search results)
    if (!data.animationIndex) {
        item.style.opacity = 1;
        item.style.transform = 'translateY(0)';
    }

    return item;
}

async function loadMusic() {
    if (allTracks.length === 0) {
        console.log("Loading music data from Firebase...");
        const querySnapshot = await getDocs(collection(db, "music"));
        let index = 0;
        querySnapshot.forEach(doc => {
            allTracks.push({ 
                id: doc.id, 
                index: index++, 
                ...doc.data() 
            });
        });
        // Sort tracks alphabetically by title for a stable list
        allTracks.sort((a, b) => a.title.localeCompare(b.title));
        console.log(`Loaded ${allTracks.length} tracks.`);
    }

    musicContainer.innerHTML = '';
    allTracks.forEach((data) => {
        const item = createTrackListItem(data);
        musicContainer.appendChild(item);
        
        if (!data.duration || data.duration === 0) {
            getTrackDurationFromURL(data.url, item);
        }
    });

    if (allTracks.length > 0 && currentTrackIndex === -1) {
        currentTrackIndex = allTracks[0].index; 
        loadTrack(currentTrackIndex, false); 
    }
}


// --- NEW ARTIST PAGE LOGIC ---

function loadArtistPage(artistName) {
    if (!artistName) return;

    const artistSongs = allTracks.filter(track => 
        track.artist && track.artist.toLowerCase().includes(artistName.toLowerCase())
    );

    if (artistSongs.length === 0) {
        alert(`No songs found for artist: ${artistName}`);
        return;
    }
    
    // Sort songs by a mock popularity (e.g., just take the first 10, or shuffle for variety)
    const popularSongs = artistSongs.slice(0, 10).map((song, rank) => ({ ...song, rank }));
    
    // Get the artist image (using the first song as a source)
    const artistImage = artistSongs[0].artist_image_base64 || '';

    // 1. Update the HTML elements
    artistPageName.textContent = artistName;
    
    // Apply the artist banner image
    if (artistImage) {
         artistHeader.style.backgroundImage = `url('${artistImage}')`;
    } else {
         artistHeader.style.backgroundImage = 'none';
         artistHeader.style.backgroundColor = '#303030';
    }

    // 2. Clear and render the popular tracks list
    artistPopularTracks.innerHTML = '';
    popularSongs.forEach((data) => {
        const item = createTrackListItem(data, 'popular');
        artistPopularTracks.appendChild(item);
        
        // Staggered animation
        item.style.opacity = 0;
        item.style.transform = 'translateY(10px)';
        setTimeout(() => {
            item.classList.add('show');
        }, data.rank * 50); 
    });
    
    // 3. Set the Play button action for the whole list
    artistPagePlayBtn.onclick = () => {
        if (popularSongs.length > 0) {
            // Start playing the first song in the popular list
            loadTrack(popularSongs[0].index, true); 
        }
    };
    
    // 4. Navigate to the new page
    navigateToPage('artistPage');
    updatePlaylistView(); // Highlight the currently playing song if applicable
}


// Initialize the application: start on the library page and load data
loadMusic();
navigateToPage('libraryPage');

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.error('SW registration failed:', err));
  });
}
</script>

</body>
</html>
